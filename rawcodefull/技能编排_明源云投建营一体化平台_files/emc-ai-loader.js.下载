!function(n){"function"==typeof define&&define.amd?define(n):n()}((function(){"use strict";const n="function"==typeof Buffer,t="function"==typeof TextDecoder?new TextDecoder:void 0;"function"==typeof TextEncoder&&new TextEncoder;const e=(n=>{let t={};return n.forEach(((n,e)=>t[n]=e)),t})(Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=")),o=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,i=String.fromCharCode.bind(String),r="function"==typeof Uint8Array.from?Uint8Array.from.bind(Uint8Array):n=>new Uint8Array(Array.prototype.slice.call(n,0)),a=n=>n.replace(/[^A-Za-z0-9\+\/]/g,""),c=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,s=n=>{switch(n.length){case 4:var t=((7&n.charCodeAt(0))<<18|(63&n.charCodeAt(1))<<12|(63&n.charCodeAt(2))<<6|63&n.charCodeAt(3))-65536;return i(55296+(t>>>10))+i(56320+(1023&t));case 3:return i((15&n.charCodeAt(0))<<12|(63&n.charCodeAt(1))<<6|63&n.charCodeAt(2));default:return i((31&n.charCodeAt(0))<<6|63&n.charCodeAt(1))}},l="function"==typeof atob?n=>atob(a(n)):n?n=>Buffer.from(n,"base64").toString("binary"):n=>{if(n=n.replace(/\s+/g,""),!o.test(n))throw new TypeError("malformed base64.");n+="==".slice(2-(3&n.length));let t,r,a,c="";for(let o=0;o<n.length;)t=e[n.charAt(o++)]<<18|e[n.charAt(o++)]<<12|(r=e[n.charAt(o++)])<<6|(a=e[n.charAt(o++)]),c+=64===r?i(t>>16&255):64===a?i(t>>16&255,t>>8&255):i(t>>16&255,t>>8&255,255&t);return c},_=n?n=>r(Buffer.from(n,"base64")):n=>r(l(n).split("").map((n=>n.charCodeAt(0)))),u=n?n=>Buffer.from(n,"base64").toString("utf8"):t?n=>t.decode(_(n)):n=>l(n).replace(c,s),p=n=>u(a(n.replace(/[-_]/g,(n=>"-"==n?"+":"/"))));function f(n,t,e,o,i,r,a){try{var c=n[r](a),s=c.value}catch(n){return void e(n)}c.done?t(s):Promise.resolve(s).then(o,i)}function d(n){return function(){var t=this,e=arguments;return new Promise((function(o,i){var r=n.apply(t,e);function a(n){f(r,o,i,a,c,"next",n)}function c(n){f(r,o,i,a,c,"throw",n)}a(void 0)}))}}function g(n){return n&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n}function y(n,t){var e,o,i,r,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function c(r){return function(c){return function(r){if(e)throw new TypeError("Generator is already executing.");for(;a;)try{if(e=1,o&&(i=2&r[0]?o.return:r[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,r[1])).done)return i;switch(o=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return a.label++,{value:r[1],done:!1};case 5:a.label++,o=r[1],r=[0];continue;case 7:r=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==r[0]&&2!==r[0])){a=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){a.label=r[1];break}if(6===r[0]&&a.label<i[1]){a.label=i[1],i=r;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(r);break}i[2]&&a.ops.pop(),a.trys.pop();continue}r=t.call(n,a)}catch(n){r=[6,n],o=0}finally{e=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,c])}}}var h,k=new Map,w="_success_callback",v="_fail_callback",m="skyline_gpt_action_chat_open_card_action",A=((h=A||{}).ActionConfigSet="skyline_gpt_action_config_set",h.ActionConfigShow="skyline_gpt_action_config_show",h.ActionPageOpen="skyline_gpt_action_page_open",h.ActionPageClose="skyline_gpt_action_page_close",h.ActionChatClose="skyline_gpt_action_chat_close",h.ActionOpen="skyline_gpt_action_chat_open",h.ActionClose="skyline_gpt_action_close",h[h.ActionOpenCardAction=m]="ActionOpenCardAction",h[h.ActionOpenCardActionSuccessCallback=m+w]="ActionOpenCardActionSuccessCallback",h[h.ActionOpenCardActionFailCallback=m+v]="ActionOpenCardActionFailCallback",h.ActionOpenErrorCallback="skyline_gpt_action_chat_open_error_callback",h.ActionOpenSkillRunning="skyline_gpt_action_chat_open_skill_running",h.ActionOpenCloseCallback="skyline_gpt_action_chat_open_close_callback",h.ActionOpenChatCallback="skyline_gpt_action_chat_open_chat_callback",h.ActionChatOpen="skyline_gpt_action_chat_page_open",h.ActionChatMessageSend="skyline_gpt_action_chat_message_send",h.ActionChatMessageSync="skyline_gpt_action_chat_message_sync",h.ActionChatWelcomeMessageSend="skyline_gpt_action_welcome_message_send",h.NotifyMounted="skyline_gpt_notify_mounted",h.NotifyMountError="skyline_gpt_notify_mount_error",h.NotifyConfigMounted="skyline_gpt_notify_config_mounted",h.NotifyConfigError="skyline_gpt_notify_config_error",h.ActionMediaPreview="skyline_gpt_media_preview",h.ActionMediaNotification="skyline_gpt_media_notification",h.ActionMediaScreenshot="skyline_gpt_media_screenshot",h.ActionMediaScreenshotResult="skyline_gpt_media_screenshot_result",h.ActionSetToken="skyline_gpt_set_token",h.ActionToolInvoke="skyline_gpt_tool_invoke",h.ActionToolInvokeResult="skyline_gpt_tool_invoke_result",h.ActionShortcuts="skyline_gpt_shortcuts",h.ActionPlanQuery="skyline_gpt_plan_query",h.ActionPlanInvoke="skyline_gpt_plan_invoke",h),b=["skyline_gpt_notify_mounted","skyline_gpt_notify_mount_error"],C=function(n,t,e){S(),b.includes(n)&&S(window.parent);var o=[window];try{e&&o.every((function(n){return n!==e})),o.every((function(n){return n!==window.parent}))&&o.push(window.parent),o.every((function(n){return n!==window.top}))&&o.push(window.top),o.every((function(n){return n!==window.parent.parent}))&&o.push(window.parent.parent),o.every((function(n){return n!==window.parent.parent.parent}))&&o.push(window.parent.parent.parent)}catch(t){t&&console.warn("GPT: Error sending signal ".concat(n,":"),t.message)}finally{o.forEach((function(e){return e.postMessage({type:n,data:t},"*")}))}},S=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window;try{return"function"==typeof window.parent.addEventListener?window.parent:n}catch(t){return n}},O=function(n,t){var e=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:S(),i=function(o){if(o.data.type===n){var r,a,c,s=o.data.data,l=t(s,o.source);"card-confirm"===(null==s||null===(r=s.data)||void 0===r?void 0:r.name)&&(null==s||null===(c=s.data)||void 0===c||null===(a=c.message)||void 0===a?void 0:a.id)&&("object"===(void 0===l?"undefined":g(l))&&"function"==typeof l.then?l.then((function(){o.source.postMessage({type:n+w,data:{id:s.data.message.id}})}),(function(){o.source.postMessage({type:n+v,data:{id:s.data.message.id}})})):o.source.postMessage({type:n+w,data:{id:s.data.message.id}})),e&&x(n,i)}};!function(n,t,e){var o=k.get(n);o||(k.set(n,new Map),o=k.get(n)),o.set(t,e)}(n,t,i),o.addEventListener("message",i)},x=function(n,t){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:S(),o=function(n,t){var e=k.get(n);if(e){var o=e.get(t);if(o)return e.delete(t),o}}(n,t);o&&e.removeEventListener("message",o)},E=function(n,t){var e=function(n){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],e=new URL(n);return n.startsWith("blob:")?e.search="":t&&e.searchParams.set("t","".concat(Date.now())),e}(n,!(arguments.length>2&&void 0!==arguments[2])||arguments[2]);n=e.toString();var o=document.createElement("script");return o.type="module",o.async=!0,Object.keys(t).forEach((function(n){var e=t[n];o.setAttribute(n,e)})),o.src=n,document.body.appendChild(o),o},P={open:function(n){return C("skyline_gpt_action_chat_page_open",n)},welcome:function(n){return C("skyline_gpt_action_welcome_message_send",n)},send:function(n){C("skyline_gpt_action_chat_message_send",n)},sync:function(n){return C("skyline_gpt_action_chat_message_sync",n)}},M=function(){return C("skyline_gpt_action_config_set",{context:arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}}),new Promise((function(n,t){O("skyline_gpt_notify_config_mounted",n),O("skyline_gpt_notify_config_error",t)}))},j=function(n){return C("skyline_gpt_set_token",n)},T=function(){var n=d((function(){var n,t,e,o,i=arguments;return y(this,(function(r){return"object"===(void 0===(n=i.length>0&&void 0!==i[0]?i[0]:{})?"undefined":g(n))&&(t=Object.keys(n),e=!t.length,o=n.feature,e||o)?[2,F(n)]:"string"==typeof(a=n)&&(a.startsWith("http")||a.startsWith("/")||a.startsWith("blob:"))?[2,R(n)]:[2,L(n)];var a}))}));return function(){return n.apply(this,arguments)}}(),F=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=new URL(location.origin);return t.pathname="/gptbuilder/launcher/index.js",n.feature&&t.searchParams.set("feature",n.feature),U(t.toString())},U=function(){var n=d((function(n){return y(this,(function(t){return document.querySelector("[src='".concat(n,"']"))?[2,Promise.resolve()]:"string"!=typeof n?(console.warn("请检查资源地址是否正确"),[2]):(E(n,{}),[2,new Promise((function(n,t){O("skyline_gpt_notify_mounted",(function(){n()})),O("skyline_gpt_notify_mount_error",t)}))])}))}));return function(t){return n.apply(this,arguments)}}(),R=function(){var n=d((function(n){var t;return y(this,(function(e){return(t=document.querySelector("[data-gpt-status]"))?[2,Promise.resolve()]:"string"!=typeof n?(console.warn("请检查资源地址是否正确"),[2]):(t=E(n,{"data-gpt-status":"loading"}),[2,new Promise((function(n,e){O("skyline_gpt_notify_mounted",(function(){t.setAttribute("data-gpt-status","loaded"),n()})),O("skyline_gpt_notify_mount_error",e)}))])}))}));return function(t){return n.apply(this,arguments)}}(),L=function(){var n=d((function(n){var t,e,o,i,r;return y(this,(function(a){try{return t=n,e="","object"===(void 0===n?"undefined":g(n))&&(t=n.token,e=n.container||""),(o=JSON.parse(p(t||""))).shareCode&&o.baseUrl&&o.jsUrl&&o.accessToken?(i={id:"skyline-gpt","data-gpt-status":"loading","data-gpt-share":o.shareCode,"data-gpt-history":o.history||"1","data-gpt-base-url":o.baseUrl},e&&(i["data-gpt-container"]=e),r=E(o.jsUrl,i),[2,new Promise((function(n,t){O("skyline_gpt_notify_mounted",(function(){r.setAttribute("data-gpt-status","loaded"),j(o.accessToken),M({}).then(n).catch(t)})),O("skyline_gpt_notify_mount_error",t)}))]):[2]}catch(n){console.log(n)}return[2]}))}));return function(t){return n.apply(this,arguments)}}(),N=function(n){},B=function(n){},q=function(n){},I=function(){},G=function(n){},W=function(n){x(A.ActionOpenCardAction,N,window),x("skyline_gpt_action_chat_open_error_callback",B,window),x("skyline_gpt_action_chat_open_skill_running",q,window),x("skyline_gpt_action_chat_open_close_callback",I,window),x("skyline_gpt_action_chat_open_chat_callback",G,window);var t=n;t&&t.onCardAction&&(N=t.onCardAction,t.onCardAction=void 0,t.hasOnCardAction=!0),t&&t.onError&&(B=t.onError,t.onError=void 0,t.hasOnError=!0),t&&t.onSkillRunning&&(q=t.onSkillRunning,t.onSkillRunning=void 0,t.hasOnSkillRunning=!0),t&&t.onClose&&(I=t.onClose,t.onClose=void 0,t.hasOnClose=!0),t&&t.onChat&&(G=t.onChat,t.onChat=void 0,t.hasOnChat=!0),C("skyline_gpt_action_chat_open",n),O(A.ActionOpenCardAction,N,!1,window),O("skyline_gpt_action_chat_open_error_callback",B,!1,window),O("skyline_gpt_action_chat_open_skill_running",q,!1,window),O("skyline_gpt_action_chat_open_close_callback",I,!1,window),O("skyline_gpt_action_chat_open_chat_callback",G,!1,window)},z={init:function(){return R("https://aiengine.tj.mycyjg.com/gptbuilder/launcher/kf.js")},open:function(n){return W({feature:"kefu",context:n.context})}},D=function(n){return C("skyline_gpt_media_notification",n)},Z=function(){var n=d((function(){return y(this,(function(n){return C("skyline_gpt_media_screenshot"),[2,new Promise((function(n){O("skyline_gpt_media_screenshot_result",(function(t){n(t)}),!0,window)}))]}))}));return function(){return n.apply(this,arguments)}}(),J={preview:function(n){return C("skyline_gpt_media_preview",n)},notification:D,screenshot:Z},$={open:function(n){return C("skyline_gpt_action_page_open",n)},close:function(){return C("skyline_gpt_action_page_close")}},K=function(){},Q=function(n,t){x("skyline_gpt_action_chat_open_close_callback",K,window);var e=n;"object"===(void 0===e?"undefined":g(e))&&e.onClose&&(K=e.onClose,e.onClose=void 0,e.hasOnClose=!0),C(t,e),O("skyline_gpt_action_chat_open_close_callback",K,!1,window)},H={invoke:function(n){Q("string"==typeof n?{id:n}:n,"skyline_gpt_plan_invoke")},query:function(n){Q(n,"skyline_gpt_plan_query")}},V=function(){var n=d((function(n){return y(this,(function(t){return C("skyline_gpt_shortcuts",n),[2]}))}));return function(t){return n.apply(this,arguments)}}(),X={shortcuts:V},Y=function(){var n=d((function(n,t){return y(this,(function(e){return C("skyline_gpt_tool_invoke",{id:n,params:t}),[2,new Promise((function(n,t){var e=function(t,o){x("skyline_gpt_tool_invoke_result",e),n(t)};O("skyline_gpt_tool_invoke_result",e)}))]}))}));return function(t,e){return n.apply(this,arguments)}}(),nn={setAccessToken:j,open:W,show:function(){return C("skyline_gpt_action_config_set",{visible:!0})},hide:function(){return C("skyline_gpt_action_config_set",{visible:!1})},close:function(){return C("skyline_gpt_action_close")},setContext:M,init:T,createIcon:function(n){var t;(t="string"==typeof n.el?document.querySelector(n.el):n.el)&&(t.addEventListener("click",n.onClick),n.title&&(t.title=n.title))},notification:D,page:$,chat:P,media:J,version:"0.2.0-alpha.3",tool:{invoke:Y},skill:X,plan:H,kefu:z};if(window===window.parent){let n="/api/03011407/setting/getCustomServiceSetting",t=window?.EMC_CONFIG?.siteGuid||function(n){const t=`; ${document.cookie}`.split(`; ${n}=`);if(2===t.length)return t.pop().split(";").shift()}("LoginSite");t&&(n=n+"?siteGuid="+t),fetch(n).then((n=>{if(!n.ok)throw new Error("网络响应不是 ok");return n.json()})).then((n=>{let{enableAI:t,enableKefu:e}=n.data||{};function o(){window.addEventListener("message",(n=>{try{const t="string"==typeof n.data&&n.data.indexOf(!1)?JSON.parse(n.data):n.data;"skyline.kefu.open"===t.type&&nn.kefu.open(t.data)}catch(t){console.error("收到的消息解析失败",n,t)}}))}if(console.log("获取到的数据:",t,e),!1===t&&!0===e&&nn.kefu.init().then((()=>{o()})),!0===t){const n={};!0===e&&(n.feature="kefu"),nn.init(n).then((()=>{o()}))}})).catch((n=>{console.error("请求失败:",n)}))}}));
